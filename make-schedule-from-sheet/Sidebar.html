<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 12px; font-size: 13px; color: #333; background: #fefefe; }
      h3 { margin-top: 0; color: #444; }
      
      /* リストのデザイン */
      .event-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 1px solid #eee; 
        padding: 8px 4px; 
      }
      .event-info { flex-grow: 1; }
      .date { font-weight: bold; color: #1a73e8; font-size: 11px; }
      .title { display: block; margin-top: 2px; }
      
      /* 削除ボタン */
      .delete-btn {
        background: none; border: none; color: #999;
        font-size: 18px; cursor: pointer; padding: 0 8px;
        line-height: 1;
      }
      .delete-btn:hover { color: #d93025; }

      #preview-container { 
        margin: 15px 0; max-height: 350px; overflow-y: auto; 
        border: 1px solid #ddd; border-radius: 4px; background: white;
      }
      
      /* ボタンのデザイン */
      button.main-btn { 
        width: 100%; padding: 12px; border: none; border-radius: 4px; 
        font-weight: bold; cursor: pointer; transition: 0.3s;
      }
      .btn-blue { background: #1a73e8; color: white; }
      .btn-blue:hover { background: #1557b0; }
      .btn-secondary { background: #f1f3f4; border: 1px solid #ccc; margin-bottom: 10px; }
      
      /* 完了状態のスタイル */
      .btn-success { background: #1e8e3e !important; color: white; cursor: default; }
      
      .error { color: #d93025; padding: 10px; }
      .empty-msg { color: #666; padding: 20px; text-align: center; }
    </style>
  </head>
  <body>
    <h3>カレンダー登録</h3>
    <button class="main-btn btn-secondary" onclick="generatePreview()">選択範囲を読み込む</button>
    
    <div id="preview-container">
      <p class="empty-msg">範囲を選択して読み込んでください</p>
    </div>

    <button id="reg-btn" class="main-btn btn-blue" onclick="register()" style="display:none;">カレンダーに追加する</button>

    <script>
      let currentEvents = [];

      // プレビューの表示更新
      function renderList() {
        const container = document.getElementById('preview-container');
        const regBtn = document.getElementById('reg-btn');
        
        if (currentEvents.length === 0) {
          container.innerHTML = '<p class="empty-msg">登録対象がありません</p>';
          regBtn.style.display = 'none';
          return;
        }

        let html = "";
        currentEvents.forEach((ev, index) => {
          html += `
            <div class="event-item">
              <div class="event-info">
                <span class="date">${ev.dateStr}</span>
                <span class="title">${ev.title}</span>
              </div>
              <button class="delete-btn" onclick="removeItem(${index})">&times;</button>
            </div>`;
        });
        container.innerHTML = html;
        regBtn.style.display = 'block';
        resetButton(); // 読み込み直後はボタンを通常状態に戻す
      }

      function generatePreview() {
        document.getElementById('preview-container').innerHTML = '<p class="empty-msg">読み込み中...</p>';
        google.script.run
          .withSuccessHandler(function(events) {
            currentEvents = events;
            renderList();
          })
          .withFailureHandler(function(err) {
            document.getElementById('preview-container').innerHTML = `<p class="error">${err.message}</p>`;
          })
          .getSelectedPreview();
      }

      function removeItem(index) {
        currentEvents.splice(index, 1);
        renderList();
      }

      function register() {
        const btn = document.getElementById('reg-btn');
        btn.disabled = true;
        btn.innerText = "登録中...";
        btn.className = "main-btn btn-blue"; // 青のまま

        google.script.run
          .withSuccessHandler(function(count) {
            // 完了時の演出
            btn.innerText = "登録完了！ (" + count + "件)";
            btn.className = "main-btn btn-success"; // 緑色に変更
            
            // 3秒後にリストを空にしてボタンを隠す
            setTimeout(() => {
              currentEvents = [];
              renderList();
            }, 3000);
          })
          .withFailureHandler(function(err) {
            alert("エラー: " + err.message);
            resetButton();
          })
          .registerEvents(currentEvents);
      }

      function resetButton() {
        const btn = document.getElementById('reg-btn');
        btn.disabled = false;
        btn.innerText = "カレンダーに追加する";
        btn.className = "main-btn btn-blue";
      }
    </script>
  </body>
</html>